## 数据库设计规范

>  这些规范是对开发过程中因数据库设计导致的API开发问题进行总结，定义数据设计规范，以避免同类问题再次出现。
>
> Version:1.0

### 关于数据库 sql 文件管理
> 各个模块各自管理模块相关的数据库文件, 无关模块的数据表sql文件以及基础模块的数据库.sql 无需作为代码提交

> > 不能直接从数据库中导出 sql文件作为模块代码中的 resource/sql/app-schema.sql 提交

### 数据表名命名规范
- 系统表名以 t_ 作为前缀
- 项目或子系统表名以项目或子系统缩写作为前缀 如  cms_, vms_, crm_, vip_
- 表名前缀 不能超过 3 个英文字符（不包括 下划线）

### 数据库关键字段定义标准

| **Field Name**     | **Type**    | **Description**                                              |      |
| ------------------ | ----------- | ------------------------------------------------------------ | ---- |
| id                 | bigint(20)  | 实体id, bigint(20)                                           |      |
| pid                | bigint(20)  | 父节点ID，不用parent_id                                      |      |
| org_id             | bigint(20)  | 用于隔离的组织id, 由crud-plus维护                              |      |
| org_tag            | varchar(100)| 用于隔离的组织标识, 参考 docker而定                             |      |
| category_id        | bigint      | 所属分类ID                                                   |      |
| name               | String      | 表示实体名称及同一数据表内的其他相关字段                     |      |
| code               | String      | 主表实体编号，除名字外标记实体唯一属性，设备id用 sn          |      |
| {entity}_no        | String      | 关联表的实体编号，如 vip_no                                  |      |
| {entity}_number    | String      | 流水编号，由 实体名+Number 组成， 如 order_number            |      |
| sn                 | String      | 设备编码，用于硬件设备序列号                                 |      |
| status             | varchar(26) | 实体状态，不能用 state, 其他状态用 stat                      |      |
| sort_num           | int         | 实体排序号（不能用sort,为数据库保留字段）,meta 字段开发保留字段   /api/meta/patch/entity/{entity}/action/moveup/row/{id}/row/{nextId}   /api/meta/patch/entity/{entity}/action/movedown/row/{id}/row/{nextId} |      |
| enabled            | smallint    | 启用/禁用，不用enable                                        |      |
| invalid            | smallint    | 是否失效, 默认为0/有效                                       |      |
| is_deleted         | smallint    | 逻辑删除 默认值0, 1为删除标记                                |      |
| version            | int         | 版本号，myBatis保留字段，用于多用户同时更新锁定              |      |
| **时间相关**       |             |                                                              |      |
| create_time       | Datetime    | 实体创建时间,crud-plus框架保留字段**,**自动忽略更新          |      |
| last_modified_time | Timestamp   | 用于对实体信息作了修改的时间，通常用于跟踪实体的修改时间，对修改频率比较高的实体必须具备有此字段。crud-plus框架保留字段，且自动刷新修改时间   `last_modified_time`   datetime DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP |      |
| update_time       | Datetime    | 一般用于内容的更新，如文章内容,实体备注等。crud-plus框架保留字段，且自动刷新修改时间   `updated_time` datetime DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP |      |
| register_time      | Datetime    | 注册时间，通常用于除created_time之外的注册事件进行记录。     |      |
| closed_time        | Datetime    | 用于状态的关闭时间                                           |      |
| expired_time       | Datetime    | 事件过期时间，不能用expire_time,   end_time                  |      |
| start_time         | Datetime    | 事件开始时间，通常用于查询。不能用begin_time                 |      |
| end_time           | Datetime    | 用于时间段结束时间, 通常用于查询                             |      |
| **人力资源相关**   |             |                                                              |      |
| gender             | smallint    | 原规范原项目保留   0 -保密， 1-男， 2-女   新规范新项目新定义   0 –男， 1-女，空值-保密，2-保密 |      |
| dob                | Datetime    | 生日, 不用birthday                                           |      |
| author             | String      | 作者, 通常是指文章（用于记录，不作外键关链），               |      |
| scheduler          | String      | 制表人（用于记录，不作外键关链）                             |      |
| applicant          | String      | 申请人-通常用于流程                                          |      |
| created_by         | String      | 创建人                                                       |      |
| followed_by        | String      | 跟进人                                                       |      |
| processed_by       | String      | 受理人                                                       |      |
| approved_by        | String      | 审批人-通常指流程                                            |      |
| charged_by         | String      | 收费单位                                                     |      |
| **销售相关**       |             |                                                              |      |
| transaction        | String      | 流水号，用于处理订单号等，与时间序列有关                     |      |
| discount           | int         | 折扣 用整型表示                                              |      |
| price              | BigDecimal  | 价格                                                         |      |

### 数据设计规范说明
| 关于字段唯一性   | 充分考虑唯一字段的unique属性，从数据级别保证数据唯一性       |
| ---------------- | ------------------------------------------------------------ |
| 关于字段命名     | 数据字段命令统一用小写，下划线，即使专用名词也采用小写，如生日DOB,用小写 dob |
| 关于非空字段     | 考虑NOT NULL字段的必要性，非必要字段不考虑NOT NULL, 如   category_id,pid<br />NOT NULL考虑字段如   ●name   ●status |
| 关于可为空字段   | 对于可为空的字段，在不影响业务的情况下，对可为空的字段设置必要的默认值，尽量使用 default ‘必要的默认值’代替 default null ，达到减少必要的代码层值得判断。 |
| 关于冗余字段说明 | 没有适当的冗余导致复杂的查询 - 数据库设计时进行必要的数据冗余，如下情况适用【字段冗余】   e.g:   1.记录类型实体(如审批记录等），需冗余关联实体的名称或是前端需要展示的属性，避免关联实体的“删增改”操作影响记录值，同时减少查询时join表的操作以及删除关联实体导致的查找关联实体引用错误。 |
| 数据库设计       | 数据类型   1.   不允许使用double数据类型，需要小数的情况使用   decimal类型；bool   类型 使用smallint   2.   时间相关字段固定数据类型datetime |
| 数据库设计       | 对于新建时间(或其他在插入时需要使用当前时间的时间类型字段)  考虑使用 timestamp not null   default current_timestamp ，将时间赋值权交由数据库处理 (MySQL5.6 及以上版本支持) |
| 数据库设计       | 表与表之间的关系使用数据表外键关联，不在业务层控制表与表之间的关系。 |
| 数据库设计       | 对用户跨服务或跨平台的访问不能以表自增ID作为唯一标识。即跨服务或跨平台时，表的设计就不应以user_id作为用户的唯一标识。   e.g.   唯一符识符可以考虑account, openid, registerMobile,registerEmail 其中之一。 |


### 修改表结构参考

> 添加一个字段
```
ALTER TABLE table_name ADD `field_name` varchar(26) DEFAULT null COMMENT '描述';
```

> 修改字段名称
```
ALTER TABLE table_name CHANGE COLUMN origin_name  `new_name` VARCHAR(20) DEFAULT NULL COMMENT;
```

> 修改字段类型
```
ALTER TABLE table_name MODIFY `modify_column` VARCHAR(10);
```

> 删除一个字段
```
ALTER TABLE table_name DROP COLUMN `column_name`;
```

> 新建唯一索引
```
ALTER TABLE table_name ADD UNIQUE KEY (`unique_column`);
```

> 修改唯一为组合键唯一 (首先删除该唯一再插入)
```
 SHOW create table table_name; 

 ALTER TABLE table_name DROP INDEX `unique_name`;
 
 ALTER TABLE table_name ADD UNIQUE KEY (`unique_column1`,` unique_column1`);
```

### 根据orgId隔离SQL示例 查询语句隔离格式
```sql
 <sql id="QueryOwnedOrgIds">
     SELECT children.id FROM t_sys_org, t_sys_org as children WHERE t_sys_org.left_num &lt;= children.left_num AND
            t_sys_org.right_num >= children.left_num and t_sys_org.id=#{record.orgId} order by t_sys_org.node_level ASC
 </sql>

 <select id="" resultType="">
        SELECT t_entity_table.*
        FROM t_entity_table
        <if test="record.orgId > 0">
            ,(<include refid="QueryOwnedOrgIds"></include>) AS ownedOrgIds
        </if>
        WHERE 1=1
        <if test="record.orgId > 0">
            AND t_entity_table.org_id = ownedOrgIds.id
        </if>
 </select>
```

#### 完整SQL例子
```
SELECT
	t_test_saas_entity.*
FROM
	t_test_saas_entity,
	(
		SELECT
			children.id
		FROM
			t_sys_org,
			t_sys_org AS children
		WHERE
			t_sys_org.left_num <= children.left_num
		AND t_sys_org.right_num >= children.left_num
		AND t_sys_org.id = 100000000000000010
		ORDER BY t_sys_org.node_level ASC
	) AS ownedOrgIds
WHERE
	1 = 1
AND t_test_saas_entity.org_id = ownedOrgIds.id
```

