## 如何快速部署`.netcore`服务

#### 安装`dotnet sdk`
[dotnet 3.1 LTS](https://dotnet.microsoft.com/download/dotnet/3.1)


#### 新建`WebApi`项目
```shell
mkdir app.name
cd app.name
dotnet new webapi 
dotnet clean 
dotnet build
dotnet publish app.name.csproj -c Release -o /app/publish
```

## 本地构建`app.name.dll`
在本地通过 `visual studio 2019` 构建`app.name.dll`包

- 登录服务器创建目录结构如下
```
├── api
│   └── app.name.dll
└── docker-compose.yml
```

#### `docker-compose.yml`
```YAML
version: '3.4'
## change target_network to the current working network
services:
  api:
    image: mcr.microsoft.com/dotnet/runtime:3.1
    restart: always
    privileged: true
    working_dir: /app
    logging: 
      driver: "json-file"
      options:
        max-size: "5m"
    volumes:
      - ./bin:/app/publish
      - ./api/app.name.dll:/app/publish/app.name.dll
    entrypoint: 
      - dotnet
      - app.name.dll
    networks: 
      - target_network

networks: 
  target_network:
    external: false  
```

#### 基于`docker-compose`部署
```shell
docker-compose up -d
```

## 源代码部署
- 登录服务器创建目录结构如下
```
├── src
│   │── app.name.csproj
│   │── Program.cs
│   │── Startup.cs
│   │── appsettings.Development.json
│   └── appsettings.json 
├── Dockerfile
└── docker-compose.yml
```

#### `Dockerfile` 
```Dockerfile
ARG NETCORE_APP_NAME
FROM mcr.microsoft.com/dotnet/runtime:3.1 AS base

FROM mcr.microsoft.com/dotnet/sdk:3.1 AS build
WORKDIR /src
COPY ./src .
RUN dotnet restore "${NETCORE_APP_NAME}.csproj"
RUN dotnet build "${NETCORE_APP_NAME}.csproj" -c Release -o /app/build

FROM build AS publish
RUN dotnet publish "${NETCORE_APP_NAME}.csproj" -c Release -o /app/publish

FROM base AS final
WORKDIR /app
COPY --from=publish /app/publish .
ENTRYPOINT ["dotnet", "${NETCORE_APP_NAME}.dll"]
```

#### `docker-compose.yml`
```YAML
version: '3.4'
## chagne apiservicename as the service name
## change target_network to the current working network
services:
  api:
    image: apiservicename:latest
    build:
      context: .
      dockerfile: ./Dockerfile
      args: 
        NETCORE_APP_NAME: 'api.service.name'
    restart: always
    privileged: true
    working_dir: /app
    logging: 
      driver: "json-file"
      options:
        max-size: "5m"
    networks: 
      - target_network

networks: 
  target_network:
    external: false
```

#### 基于`docker-compose`的构建与部署
```shell
docker-compose up --build -d
```

- 或构建成功之后再部署
```shell
docker-compose build --no-cache
docker-compose up -d
```
