## 微服务通信

# 教训
- 两个微服务（商城微服务,会员微服务）维护同一个业务数据（邀请人），任何一方修改数据，通过RabbitMQ通知另一方，导致消息相互影响，以及消息无限循环
- 需要区分微服务间同步数据，还是外部API调用更新数据
- 消息日志不够完整，遇到问题难定位
- 没有测试模拟器，无法快速测试

## 逻辑规范
* 对于复杂的业务流程逻辑（如业务核心流程），必须保证其正确性，连续性，并且逻辑必须清晰，不然会引起系统的不可控连锁反映。
  - 代码级别逻辑audit机制，出现逻辑错误需报警
  - 离线audit机制，出现逻辑错误需报警
  - 代码级别多抛出防止逻辑性错误异常
  - 尽量多写日志用于出错时的分析

# 解决之道
- 从架构上避免数据同步
- 数据同步是最佳方案情况下，避免双向同步（采用单向同步）
- 使用gateway整合数据优于 消息同步
- 数据整合查询，通过门户gateway进行数据整合
- 跨微服务数据更新，通过前端界面进行分离，根据不同数据来源向不同微服务发起修改请求

## 防范空指针
* 禁止连续使用点(.)操作以避免空针错误，多点操作改为分多段代码并加非空判断
*	尽量多判断输入参数或返回对象是否为null, 如果输入参数或返回对象不能为空，则抛出异常(throw new RuntimeException())；
  如果返回对象可以为空，则通过if跳过空指针
*	禁止使用多点操作，因为多点操作很容易出现空针指；对多点操作应分开多行获取对象，并对获取的对象进行非空判断
*	查询数据库业务数据时，如果非查询单个实体记录详情，不使用select \*，按照业务需求提供必要的字段信息返回给前端
* 不使用selectList.get(0)函数去获取需要操作的实体类
* 使用selectOne函数需要确定获取结果的唯一性，selectOne函数一般是对存在组合键的实体类进行查询
* 需要连表查询请直接在xml文件中编码对应的sql语句，摈弃在实现类中通过关联的实体类的Mapper对关联的实体进行查询后再进行值的插入，此方法在数据库无记录的情况下会频繁出现空指针异常

### 代码规范
- 深入理解 **Exception**及**RuntimeException**, 主动抛出(throw)异常效保证外部(external)输入参数正确
- 多字符串连接禁止使用+，使用 **String.format** 或者 **StringBuilder** 进行连接
- 路径分隔符禁止使用 \ 和 / ，统一使用 **File.separator**
- 谨防多点操作，容易报空指针错误,注意Long Integer与  int  long 引起的空指针问题
- JSON空实体不能用 ””, 因为 "" 代表空字符串, 提交空字符串到实体将导致JSON格式解释错误。应该用: {}
  ```shell
  e.g.  {"id":0, "name":"entity", "meta": {} }
  ```
- 尽量多写log，标记重要代码段信息输出
